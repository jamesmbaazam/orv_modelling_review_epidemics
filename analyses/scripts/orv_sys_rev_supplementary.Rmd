---
title: "Outbreak response models of vaccine-preventable diseases in humans (1970-2019) - A systematic review"
subtitle: "Supplementary file"
author: "James M. Azam, Xiaoxi Pang, Elisha B. Are, Juliet R.C. Pulliam, Matthew J. Ferrari"
output:
  pdf_document:
    toc: yes
    fig_crop: no
---

```{r echo=FALSE, message=FALSE, include=FALSE}
#' load packages
library('tidyverse')
library('ggthemes')
library('scales')
library('janitor')
library('countrycode')
library('bib2df')
library('conflicted')
library('here')

#resolve package function conflicts
conflict_prefer('filter', 'dplyr')
conflict_prefer('select', 'dplyr')
conflict_prefer('kable', 'knitr')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      dev = 'png', 
                      out.height = "\\textheight",  
                      out.width = "\\textwidth", 
                      message = FALSE, 
                      warning = FALSE
                      )
```

```{r}
#Paths to the datasets
args <- c(
  here::here("data", "review_data_long_cleaned.rds"),
  here::here("data", "compact_data_with_citation_keys_cleaned.rds")
  )
# Load the cleaned data 
long_data <- readRDS(args[1])

# The data with citations 
compact_data_with_citation_keys <- readRDS(args[2])

# Keep the human disease studies (NB: We only use the FMD papers for comparison)
long_data_no_fmd <- long_data %>% filter(disease != 'fmd') 

data_without_fmd <- compact_data_with_citation_keys %>% 
  filter(disease != 'fmd') 

# Filter the FMD data
data_fmd_only <- compact_data_with_citation_keys %>% 
  filter(disease == 'fmd') 
```

# Human vaccine-preventable diseases

## Studies per collaboration type

```{r echo=FALSE}
#' Count the number of each author affiliation type per year (including FMD)
collap_types_by_year <- data_without_fmd %>% 
  mutate(year_aggreg = as.numeric(ifelse(publication_year < 2006, 
                                         2005, 
                                         publication_year
                                         )
                                  ), 
         collab_type = as_factor(if_else(author_affiliation_type == 'academic_institutions', 
                                         'Purely academic', 
                                         'Mixed')
                                 )
         ) %>% 
  count(year_aggreg, collab_type, name = 'num_of_studies') %>% 
  pivot_wider(names_from = collab_type, values_from = num_of_studies)

knitr::kable(collap_types_by_year %>% 
               clean_names() %>% 
               adorn_totals(... = c(mixed, purely_academic), 
                            where = c("row", "col")
                            )
             )
```

```{r echo=FALSE}
#' Count by collaboration types and make a bar plot
collab_types_count <- data_without_fmd %>%
  count(author_affiliation_type, sort = TRUE, name = "num_of_studies") %>% 
  mutate(author_affiliation_type = as_factor(author_affiliation_type)) %>% 
  arrange(desc(num_of_studies))

knitr::kable(collab_types_count)
```

# Number of studies per disease and intervention.
## Diseases studied
```{r echo=FALSE}
disease_studied_count <- long_data_no_fmd %>% 
  group_by(disease) %>% 
  distinct(title) %>% 
  count(disease, name = 'num_of_studies', sort = TRUE) %>%
  ungroup() 

knitr::kable(disease_studied_count, col.names = c('Disease', 'Number of studies'))
```

## Diseases and interventions

```{r echo=FALSE}
#count the number of unique interventions modelled
interventions_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(intervention_modelled, .keep_all = TRUE) %>% 
  ungroup()

#interventions are disease specific
interventions_per_disease <- interventions_unique_entries %>% 
  mutate(intervention_modelled = str_trim(intervention_modelled)) %>% 
  filter(intervention_modelled != 'e.g.') %>% #remove false rows
  filter(intervention_modelled != 'various') %>% #remove false rows
  count(disease, intervention_modelled, name = 'num_of_studies') %>% 
  arrange(disease, desc(num_of_studies)) %>% 
  ungroup()

knitr::kable(interventions_per_disease)
```

## Outcomes studied

```{r echo=FALSE}
#count the number of unique outcomes measured
outcomes_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(outcome_measured, .keep_all = TRUE) %>% 
  ungroup()
  
#Count the number of studies 
outcomes_count <- outcomes_unique_entries %>% 
  count(outcome_measured, name = 'num_of_studies', sort = TRUE) %>% 
  ungroup() %>% 
  filter(outcome_measured != 's') 

knitr::kable(outcomes_count,
             caption = "Count of outcomes measured")
```

## Model structure type

```{r echo=FALSE}
#Keep only the unique entries 
model_structure_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(model_structure) %>% 
  ungroup()

#Count the number of studies
model_structure_unique_count <- model_structure_unique_entries %>%
    count(model_structure, model_structure, name = 'num_of_studies') 

#Print the table
knitr::kable(model_structure_unique_count)
```

## Model structure and sensitivity analysis

```{r echo=FALSE}
#Keep only the unique entries
sensitivity_analysis_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(sensitivity_analysis, .keep_all = TRUE) %>% 
  ungroup()

#Count the number of studies
sensitivity_analysis_count <- sensitivity_analysis_unique_entries %>% 
  count(model_structure, sensitivity_analysis, name = 'num_of_studies') 

#Print the table
knitr::kable(sensitivity_analysis_count)
```

## Data use and availability

```{r echo=FALSE}
#Keep only the unique entries
code_and_data_availability_count <- data_without_fmd %>% 
  count(data_used, data_available, name = 'num_of_studies') 

#Print the results
knitr::kable(code_and_data_availability_count, caption = 'Data use and availability')
```

## Code availability
```{r echo=FALSE}
#Keep only the unique entries
code_availability_count <- data_without_fmd %>% 
  count(simulation_code_available, name = 'num_of_studies') 

#Print the results
knitr::kable(code_availability_count, caption = 'Code availability')
```

## Outbreak type

```{r echo=FALSE}
#count the number of unique diseases studied
disease_studied_by_outbreak_type <- data_without_fmd %>% 
  mutate(disease = as_factor(disease), 
         outbreak_type = as_factor(str_replace(outbreak_type, ' ', '+'))
         ) %>% 
  group_by(disease) %>% 
  distinct(title, .keep_all = TRUE) %>% 
  count(disease, outbreak_type, sort = TRUE, name = 'num_of_studies') %>%
  pivot_wider(names_from = outbreak_type, values_from = 'num_of_studies') %>% 
  replace_na(list(hypothetical_outbreak = 0, real_outbreak = 0)) %>% 
  mutate(total = hypothetical_outbreak + real_outbreak) %>% 
  arrange(desc(total))

knitr::kable(disease_studied_by_outbreak_type)
```

## Objective types

```{r echo=FALSE}
#count the number of unique diseases studied
disease_studied_by_objective_type <- data_without_fmd %>% 
  mutate(disease = as_factor(disease), 
         objectives = as_factor(objectives)
         ) %>% 
  group_by(disease) %>% 
  distinct(title, .keep_all = TRUE) %>% 
  count(disease, objectives, name = 'num_of_studies') %>%
  pivot_wider(names_from = objectives, values_from = num_of_studies) %>% 
  replace_na(list(future = 0, past = 0, both = 0)) %>% 
  mutate(total = future + past + both) %>% 
  arrange(desc(total))

knitr::kable(disease_studied_by_objective_type)
```

## Geographic analyses
```{r echo=FALSE}
fmd_studies_by_collab_type <- data_fmd_only %>% 
  mutate(disease = as_factor(disease), 
         author_affiliation_type = as_factor(str_replace(author_affiliation_type, ' ', '+'))
         ) %>% 
  mutate(collab_type = as_factor(if_else(author_affiliation_type == 'academic_institutions', 
                                         'purely_academic', 
                                         'mixed')
                                 )
         ) %>% 
  count(collab_type, sort = TRUE, name = 'num_of_studies') 

knitr::kable(fmd_studies_by_collab_type)
```
## FMD by objective type
```{r echo=FALSE}
fmd_studies_by_objective_and_outbreak_type <- data_fmd_only %>% 
  count(objectives, outbreak_type, name = 'num_of_studies') %>% 
  pivot_wider(names_from = outbreak_type, values_from = num_of_studies)

knitr::kable(fmd_studies_by_objective_and_outbreak_type)
```

### Countries studied

```{r}
#Tally of how many times and percentage of times each COUNTRY has been studied
# countries_studied_by_count <- long_data_no_fmd %>% 
#     group_by(country_studied) %>%
#     distinct(title) %>% 
#     count(country_studied, name = 'num_of_studies', sort = T) %>% 
#     ungroup(country_studied) %>% 
#     mutate(country_studied = as_factor(country_studied), 
#            percentage = round(num_of_studies/sum(num_of_studies)*100, 1)
#            )

countries_studied_by_count <- data_without_fmd %>% 
    distinct(title, country_studied, .keep_all = TRUE) %>% 
    count(collab_type, country_studied, name = 'num_of_studies', sort = TRUE) 

#'Modify the data frame to lump together all countries with less than some number of studies as 'other' and recalculate the percentage studied
countries_studied_by_count_aggregated <- countries_studied_by_count %>% 
  group_by(country_studied) %>%
  summarise(num_of_studies = sum(num_of_studies),
            .groups = 'drop'
            ) %>% 
  filter(!(country_studied %in% c('none', 'west_africa', 'global', 'northern_hemisphere', 'southeast_asia', 'who_southeast_asia_region'))) %>% 
  arrange(desc(num_of_studies)) %>% 
  adorn_totals(where = c('row')) %>% 
  adorn_percentages(denominator = 'col') %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>% 
  ungroup() 

#Print the results
knitr::kable(countries_studied_by_count_aggregated, 
             caption = 'Number of studies per country'
             )
``` 



### Continents studied
```{r echo=FALSE}
continents_studied_by_count <- countries_studied_by_count %>% 
  mutate(continent_studied = countrycode(country_studied, 
                                          destination = 'continent',
                                          origin = 'iso2c',
                                          nomatch = NULL #if there is no match, keep the original
                                          )
         ) %>% 
  mutate(continent_studied = str_to_lower(continent_studied), 
         continent_studied = case_when(str_detect(continent_studied, 'asia') == TRUE ~ 'asia', 
                                         str_detect(continent_studied, 'africa') == TRUE ~ 'africa', 
                                         TRUE ~ continent_studied
                                       )
           ) %>% 
  group_by(continent_studied) %>%
  summarise(num_of_studies = sum(num_of_studies), 
            .groups = 'drop'
            ) %>% 
mutate(percentage = round(num_of_studies/sum(num_of_studies), 2)*100) %>% 
  arrange(desc(num_of_studies)) 

#Print the results
knitr::kable(continents_studied_by_count, 
             caption = 'Number of studies per country'
             )
``` 

### Country most studied
```{r echo=FALSE}
countries_studied_most <- countries_studied_by_count %>%
    filter(country_studied != 'none') %>%
    filter(num_of_studies == max(num_of_studies))

#Print the result as a table
knitr::kable(countries_studied_most,
             col.names = c('Country',
                           'Number of studies',
                           'Percentage'
                           ),
             caption = 'Most studied country'
             )
```

### Continent most studied
```{r echo=FALSE}

continent_studied_most <- continents_studied_by_count %>%
    dplyr::filter(continent_studied != 'none') %>%
    filter(num_of_studies == max(num_of_studies))


#Print the result as a table
knitr::kable(continent_studied_most,
             col.names = c('Continent',
                           'Number of studies',
                           'Percentage'
                           ),
             caption = 'Most studied continent'
             )
```

#### Studies per continent
```{r echo=FALSE}
continents_studied <- continents_studied_by_count %>%
  filter(continent_studied != 'none') %>%
  filter(continent_studied != 'global') %>%
  filter(continent_studied != 'northern_hemisphere') %>%
  group_by(continent_studied) %>%
  summarise(num_of_studies = sum(num_of_studies )) %>%
  ungroup() %>%
  mutate(percentage = round(num_of_studies/sum(num_of_studies)*100, 1))

#Print table of results
knitr::kable(continents_studied_by_count %>% arrange(desc(percentage)),
             col.names = c('Continent',
                           'Number of studies',
                           'Percentage'
                           ),
             caption = 'Number/percent of studies by continent'
             )
```

### Connection of authors to the studied locations 
# Foot and mouth disease

## Collaboration types
```{r echo=FALSE}
fmd_studies_by_collab_type <- data_fmd_only %>% 
  mutate(disease = as_factor(disease), 
         author_affiliation_type = as_factor(str_replace(author_affiliation_type, ' ', '+'))
         ) %>% 
  mutate(collab_type = as_factor(if_else(author_affiliation_type == 'academic_institutions', 
                                         'purely_academic', 
                                         'mixed')
                                 )
         ) %>% 
  count(collab_type, sort = TRUE, name = 'num_of_studies') 

knitr::kable(fmd_studies_by_collab_type)
```
## Objective types
```{r echo=FALSE}
fmd_studies_by_objective_and_outbreak_type <- data_fmd_only %>% 
  count(objectives, outbreak_type, name = 'num_of_studies') %>% 
  pivot_wider(names_from = outbreak_type, values_from = num_of_studies)

knitr::kable(fmd_studies_by_objective_and_outbreak_type)
```

## Interventions types 
```{r echo=FALSE}
intervention_categories_fmd <- data_fmd_only %>% 
  group_by(intervention_type, vax_modelled_with_non_vax) %>% 
  count(is_vax_effective, sort = TRUE, name = 'num_of_studies') %>% 
  filter(vax_modelled_with_non_vax == 'yes') %>% 
  pivot_wider(names_from = is_vax_effective, values_from = num_of_studies) %>% 
  adorn_totals(where = 'col')


knitr::kable(intervention_categories_fmd)
```

## Vaccine impact categories 
```{r echo=FALSE}
vax_impact_categories_fmd <- data_fmd_only %>%
  filter(vax_modelled_with_non_vax == 'yes') %>% 
  count(is_vax_effective, 
        name = 'num_of_studies', 
        sort = TRUE
        ) 

#Print the results
knitr::kable(vax_impact_categories_fmd %>% adorn_totals, 
             col.names = c('Vaccination is most impactful', 
                           'Number of studies'
                           ),
             caption = 'Studies\' conclusions about impact of vaccination (FMD)'
             )
```
